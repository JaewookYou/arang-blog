name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

# ë™ì‹œ ì‹¤í–‰ ë°©ì§€ - Queue ë°©ì‹ìœ¼ë¡œ ìˆœì°¨ ì‹¤í–‰
concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          command_timeout: 10m
          script: |
            # fnm í™˜ê²½ ë¡œë“œ
            export PATH="$HOME/.local/share/fnm:$PATH"
            eval "$(fnm env)"
            
            cd /home/arang/web/blog
            
            # ë°°í¬ ë½ ì²´í¬ (ë™ì‹œ ì‹¤í–‰ ë°©ì§€ ì¶”ê°€ ë³´ì•ˆ)
            LOCK_FILE="/tmp/arang-blog-deploy.lock"
            if [ -f "$LOCK_FILE" ]; then
              LOCK_AGE=$(($(date +%s) - $(stat -c %Y "$LOCK_FILE")))
              if [ $LOCK_AGE -lt 300 ]; then
                echo "â³ ë‹¤ë¥¸ ë°°í¬ê°€ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤. ëŒ€ê¸°..."
                sleep 30
              else
                echo "ğŸ”“ ì˜¤ë˜ëœ ë½ íŒŒì¼ ì œê±°"
                rm -f "$LOCK_FILE"
              fi
            fi
            touch "$LOCK_FILE"
            
            # ì•ˆì „í•œ Git ë™ê¸°í™” (ì¶©ëŒ ë°©ì§€)
            echo "ğŸ“¥ Fetching latest changes..."
            git fetch origin main
            git reset --hard origin/main
            
            # Install dependencies
            echo "ğŸ“¦ Installing dependencies..."
            npm ci --legacy-peer-deps
            
            # Build
            echo "ğŸ”¨ Building..."
            npm run build
            
            # Reload PM2
            echo "ğŸ”„ Reloading PM2..."
            pm2 reload arang-blog --update-env
            
            # ë½ íŒŒì¼ ì œê±°
            rm -f "$LOCK_FILE"
            
            echo "âœ… Deployment completed at $(date)"
