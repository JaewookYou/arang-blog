name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

# ë™ì‹œ ì‹¤í–‰ ë°©ì§€ - ì´ì „ ë¹Œë“œ ì·¨ì†Œí•˜ê³  ìµœì‹ ë§Œ ì‹¤í–‰
concurrency:
  group: deploy-production
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          command_timeout: 20m
          script: |
            set -e
            
            # í™˜ê²½ ì„¤ì •
            export PATH="$HOME/.local/share/fnm:$PATH"
            eval "$(fnm env)"
            
            DEPLOY_DIR="/home/arang/web/blog"
            BUILD_DIR="/tmp/blog-build-$$"
            
            echo "ğŸš€ Starting deployment..."
            echo "ğŸ“‚ Build directory: $BUILD_DIR"
            
            # ì´ì „ ë¹Œë“œ ë””ë ‰í† ë¦¬ ì •ë¦¬
            rm -rf /tmp/blog-build-*
            
            # 1. ì„ì‹œ ë¹Œë“œ ë””ë ‰í† ë¦¬ì— í´ë¡ 
            echo "ğŸ“¥ Cloning repository..."
            git clone --depth 1 --branch main git@github.com:JaewookYou/arang-blog.git "$BUILD_DIR"
            cd "$BUILD_DIR"
            
            # 2. í™˜ê²½íŒŒì¼ ë³µì‚¬
            echo "ğŸ“‹ Copying environment files..."
            cp "$DEPLOY_DIR/.env.local" . 2>/dev/null || true
            cp "$DEPLOY_DIR/data" . -r 2>/dev/null || true
            
            # 3. ì˜ì¡´ì„± ì„¤ì¹˜ ë° ë¹Œë“œ
            echo "ğŸ“¦ Installing dependencies..."
            npm ci --legacy-peer-deps
            npm rebuild better-sqlite3
            
            echo "ğŸ”¨ Building..."
            npm run build
            
            # 4. ë¹Œë“œ ê²€ì¦
            if [ ! -f ".next/prerender-manifest.json" ]; then
              echo "âŒ Build verification failed!"
              rm -rf "$BUILD_DIR"
              exit 1
            fi
            
            echo "âœ… Build successful!"
            
            # 5. ì›ìì  ë°°í¬ (rsyncë¡œ ë®ì–´ì“°ê¸°)
            echo "ğŸ“¤ Deploying to production..."
            rsync -a --delete --exclude='.env.local' --exclude='data' .next/ "$DEPLOY_DIR/.next/"
            rsync -a --delete node_modules/ "$DEPLOY_DIR/node_modules/"
            
            # ì†ŒìŠ¤ ì½”ë“œ ë™ê¸°í™”
            cd "$DEPLOY_DIR"
            git fetch origin main
            git reset --hard origin/main
            
            # 6. PM2 reload (graceful restart - ë‹¤ìš´íƒ€ì„ ì—†ìŒ)
            echo "ğŸ”„ Reloading PM2..."
            pm2 reload arang-blog --update-env || pm2 start arang-blog --update-env
            
            # 7. ì •ë¦¬
            rm -rf "$BUILD_DIR"
            
            echo "âœ… Deployment completed at $(date)"
