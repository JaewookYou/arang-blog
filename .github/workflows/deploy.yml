name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

# ë™ì‹œ ì‹¤í–‰ ë°©ì§€ - Queue ë°©ì‹ìœ¼ë¡œ ìˆœì°¨ ì‹¤í–‰
concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          command_timeout: 15m
          script: |
            set -e  # ì—ëŸ¬ ë°œìƒ ì‹œ ì¤‘ë‹¨
            
            # fnm í™˜ê²½ ë¡œë“œ
            export PATH="$HOME/.local/share/fnm:$PATH"
            eval "$(fnm env)"
            
            cd /home/arang/web/blog
            
            # ë°°í¬ ë½ ì²´í¬ (ë™ì‹œ ì‹¤í–‰ ë°©ì§€)
            LOCK_FILE="/tmp/arang-blog-deploy.lock"
            if [ -f "$LOCK_FILE" ]; then
              LOCK_AGE=$(($(date +%s) - $(stat -c %Y "$LOCK_FILE")))
              if [ $LOCK_AGE -lt 600 ]; then
                echo "â³ ë‹¤ë¥¸ ë°°í¬ê°€ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤. ëŒ€ê¸° (60ì´ˆ)..."
                sleep 60
              fi
              echo "ğŸ”“ ë½ íŒŒì¼ ì œê±° í›„ ì§„í–‰"
              rm -f "$LOCK_FILE"
            fi
            touch "$LOCK_FILE"
            
            # PM2 ì¤‘ì§€ (ë¹Œë“œ ì¤‘ ì„œë²„ ì ‘ê·¼ ë°©ì§€)
            echo "â¸ï¸ Stopping server..."
            pm2 stop arang-blog || true
            
            # ì•ˆì „í•œ Git ë™ê¸°í™”
            echo "ğŸ“¥ Fetching latest changes..."
            git fetch origin main
            git reset --hard origin/main
            
            # í´ë¦° ì„¤ì¹˜
            echo "ğŸ“¦ Installing dependencies..."
            rm -rf node_modules/.cache
            npm ci --legacy-peer-deps
            npm rebuild better-sqlite3
            
            # ë¹Œë“œ
            echo "ğŸ”¨ Building..."
            npm run build
            
            # ë¹Œë“œ ì™„ë£Œ í™•ì¸
            if [ ! -f ".next/prerender-manifest.json" ]; then
              echo "âŒ Build failed - prerender-manifest.json not found"
              rm -f "$LOCK_FILE"
              exit 1
            fi
            
            # PM2 ì‹œì‘
            echo "ğŸ”„ Starting server..."
            pm2 start arang-blog --update-env || pm2 restart arang-blog --update-env
            
            # ë½ íŒŒì¼ ì œê±°
            rm -f "$LOCK_FILE"
            
            echo "âœ… Deployment completed at $(date)"
