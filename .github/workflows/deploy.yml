name: Deploy to Production (Docker)

on:
  push:
    branches:
      - main
  workflow_dispatch:

# ë™ì‹œ ì‹¤í–‰ ë°©ì§€ - ì´ì „ ë¹Œë“œ ì·¨ì†Œí•˜ê³  ìµœì‹ ë§Œ ì‹¤í–‰
concurrency:
  group: deploy-production
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          command_timeout: 20m
          script: |
            set -e
            
            DEPLOY_DIR="/home/arang/web/blog"
            cd "$DEPLOY_DIR"
            
            echo "ğŸš€ Starting Docker deployment..."
            echo "ğŸ“‚ Directory: $DEPLOY_DIR"
            
            # 1. ìµœì‹  ì½”ë“œ Pull
            echo "ğŸ“¥ Pulling latest code..."
            git fetch origin main
            git reset --hard origin/main
            
            # 2. Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° ë°°í¬
            echo "ğŸ³ Building and deploying Docker container..."
            docker compose down --remove-orphans || true
            docker compose build --no-cache
            docker compose up -d
            
            # 3. ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
            echo "ğŸ” Checking container health..."
            sleep 10
            
            if docker compose ps | grep -q "Up"; then
              echo "âœ… Container is running!"
            else
              echo "âŒ Container failed to start!"
              docker compose logs --tail=50
              exit 1
            fi
            
            # 4. í—¬ìŠ¤ì²´í¬ ê²€ì¦
            echo "ğŸ¥ Verifying health check..."
            for i in {1..10}; do
              if curl -sf http://localhost:3000 > /dev/null 2>&1; then
                echo "âœ… Health check passed!"
                break
              fi
              if [ $i -eq 10 ]; then
                echo "âŒ Health check failed!"
                docker compose logs --tail=50
                exit 1
              fi
              echo "â³ Waiting for service... ($i/10)"
              sleep 5
            done
            
            # 5. ì˜¤ë˜ëœ ì´ë¯¸ì§€ ì •ë¦¬
            echo "ğŸ§¹ Cleaning up old images..."
            docker image prune -f
            
            echo "âœ… Docker deployment completed at $(date)"
